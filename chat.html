
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes cooldown { from { width: 0%; } to { width: 100%; } }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-8px); }
            40% { transform: translateX(8px); }
            60% { transform: translateX(-8px); }
            80% { transform: translateX(8px); }
        }
        @keyframes syncPulse {
            0% { transform: scale(1); opacity: 1; filter: brightness(1); }
            50% { transform: scale(1.05); opacity: 0.9; filter: brightness(1.2); }
            100% { transform: scale(1); opacity: 1; filter: brightness(1); }
        }
        @keyframes messageIn {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes ripple {
            to { transform: scale(4); opacity: 0; }
        }

        .animate-shake { animation: shake 0.2s cubic-bezier(.36,.07,.19,.97) both; }
        .animate-sync { animation: syncPulse 1s ease-in-out infinite; }
        .cooldown-bar { animation: cooldown 5000ms linear forwards; }
        
        body { 
            background-color: #020617; 
            color: #f8fafc; 
            overflow: hidden; 
            cursor: none;
        }

        #custom-cursor {
            width: 20px;
            height: 20px;
            background: rgba(99, 102, 241, 0.3);
            border: 2px solid rgba(99, 102, 241, 0.8);
            border-radius: 50%;
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            transition: transform 0.15s ease-out, background 0.2s, width 0.2s, height 0.2s;
            transform: translate(-50%, -50%);
        }

        #cursor-dot {
            width: 4px;
            height: 4px;
            background: #818cf8;
            border-radius: 50%;
            position: fixed;
            pointer-events: none;
            z-index: 10000;
            transform: translate(-50%, -50%);
        }

        .cursor-hover #custom-cursor {
            transform: translate(-50%, -50%) scale(2.5);
            background: rgba(99, 102, 241, 0.1);
            border-color: #ffffff;
        }

        .click-ripple {
            position: fixed;
            width: 10px;
            height: 10px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9998;
            transform: translate(-50%, -50%);
            animation: ripple 0.4s ease-out forwards;
        }

        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        
        .hidden-element { display: none !important; }

        .message-entry {
            animation: messageIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1) forwards;
        }

        a, button, input, textarea, [role="button"], .cursor-help {
            cursor: none;
        }

        /* Glassmorphism for bubbles */
        .glass-bubble {
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="font-sans h-screen flex flex-col">

    <div id="custom-cursor"></div>
    <div id="cursor-dot"></div>

    <!-- Developer Settings Modal -->
    <div id="dev-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-md hidden-element">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-md rounded-2xl p-6 shadow-2xl">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-2 text-indigo-400">
                    <i data-lucide="settings-2" class="w-5 h-5"></i>
                    <h3 class="font-bold uppercase tracking-widest text-sm">Developer Settings</h3>
                </div>
                <button onclick="toggleDevModal()" class="text-slate-500 hover:text-white transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Google Form Entry ID</label>
                    <input id="input-entry-id" type="text" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs focus:ring-1 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Google Form URL</label>
                    <input id="input-form-url" type="text" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs focus:ring-1 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Sheet CSV URL</label>
                    <input id="input-csv-url" type="text" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs focus:ring-1 focus:ring-indigo-500 outline-none">
                </div>
                <div class="pt-2">
                    <button onclick="saveDevSettings()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 rounded-lg text-xs transition-all active:scale-95">
                        Save & Reload Configuration
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection Lost Overlay -->
    <div id="disconnect-overlay" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-slate-950/80 backdrop-blur-xl hidden-element">
        <div class="bg-slate-900 p-8 rounded-3xl border border-slate-800 shadow-2xl flex flex-col items-center max-w-sm text-center space-y-6">
            <div class="relative">
                <div class="absolute inset-0 bg-rose-500/20 blur-2xl rounded-full animate-pulse"></div>
                <i data-lucide="x-circle" class="text-rose-500 w-16 h-16 relative"></i>
            </div>
            <div class="space-y-2">
                <h2 class="text-2xl font-black italic uppercase tracking-tighter">Connection Lost</h2>
                <p class="text-slate-400 text-sm">Sync failed. Check your internet connection or verify the Google Sheet is public.</p>
            </div>
            <button onclick="window.location.reload()" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 px-6 py-3 rounded-xl font-bold transition-all active:scale-95 shadow-lg shadow-indigo-500/20">
                <i data-lucide="refresh-cw" class="w-5 h-5"></i> Retry Connection
            </button>
        </div>
    </div>

    <!-- Header -->
    <header class="h-16 flex items-center justify-between px-6 bg-slate-900 border-b border-slate-800 shadow-lg shrink-0 z-10">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600 p-2 rounded-lg shadow-indigo-500/20 shadow-lg">
                <i data-lucide="database" class="text-white w-5 h-5"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-none italic">Chat</h1>
                <p class="text-[10px] text-slate-500 uppercase tracking-widest font-semibold">Why are you reading this?</p>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div id="status-badge" title="Double click for settings" class="cursor-help select-none flex items-center gap-1.5 px-3 py-1 rounded-full border bg-emerald-500/10 border-emerald-500/20 text-emerald-500 transition-transform active:scale-95">
                <i id="status-icon" data-lucide="wifi" class="w-3.5 h-3.5"></i>
                <span id="status-text" class="text-[10px] font-bold uppercase tracking-widest">Online</span>
            </div>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <section class="flex-1 flex flex-col relative bg-slate-950">
            <div id="messages-container" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-4 scrollbar-thin">
                <div id="loading-state" class="h-full flex flex-col items-center justify-center text-slate-600 space-y-4">
                    <i data-lucide="refresh-cw" class="w-10 h-10 animate-spin opacity-20"></i>
                    <p class="text-sm italic">Synchronizing...</p>
                </div>
            </div>

            <div class="p-4 md:p-6 bg-slate-900 border-t border-slate-800 shadow-2xl shrink-0">
                <form id="chat-form" class="max-w-4xl mx-auto space-y-3 transition-transform">
                    <div class="flex items-center justify-between px-2">
                        <div id="spam-alert" class="flex items-center gap-2 text-rose-400 text-[10px] font-bold uppercase tracking-widest hidden-element animate-pulse">
                            <i data-lucide="shield-alert" class="w-3 h-3"></i> <span id="alert-text">SPAM SHIELD: 5S DELAY</span>
                        </div>
                        <div id="normal-status" class="text-[9px] text-slate-600 uppercase tracking-widest font-bold flex items-center gap-1">
                            <i data-lucide="cloud-lightning" class="w-2.5 h-2.5 animate-pulse"></i> Row-Based Tracking Active
                        </div>
                        <div id="timer-display" class="text-[9px] text-slate-500 font-mono">5s Limit</div>
                    </div>
                    
                    <div class="relative flex items-end gap-3">
                        <div class="flex-1 relative">
                            <textarea 
                                id="msg-input"
                                rows="1"
                                placeholder="Type a message..."
                                class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all resize-none max-h-32 disabled:opacity-50"
                            ></textarea>
                            <div id="cooldown-visual" class="absolute bottom-0 left-0 h-0.5 bg-indigo-500 rounded-full hidden-element"></div>
                        </div>
                        
                        <button 
                            type="submit"
                            id="send-btn"
                            class="p-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl transition-all shadow-lg active:scale-95 disabled:bg-slate-800 disabled:text-slate-600"
                        >
                            <i data-lucide="send" id="btn-icon" class="w-5 h-5"></i>
                        </button>
                    </div>
                </form>
            </div>
        </section>
    </main>

    <script>
        // --- COOKIE MANAGEMENT ---
        function setCookie(name, value, days = 365) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = "expires=" + date.toUTCString();
            document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/;SameSite=Lax";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
            }
            return null;
        }

        // --- FINGERPRINT PERSISTENCE ---
        let myFingerprints = new Set();
        try {
            const saved = getCookie('chat_fingerprints');
            if (saved) {
                const parsed = JSON.parse(saved);
                if (Array.isArray(parsed)) {
                    myFingerprints = new Set(parsed);
                }
            }
        } catch(e) { console.warn("Cookie load failed", e); }

        function saveFingerprints() {
            // Keep only last 50 fingerprints to avoid cookie size limits (4KB)
            const recent = Array.from(myFingerprints).slice(-50);
            setCookie('chat_fingerprints', JSON.stringify(recent));
        }

        // --- CONFIG ---
        let CONFIG = {
            formUrl: localStorage.getItem('chat_form_url') || "https://docs.google.com/forms/d/e/1FAIpQLSd4P8N2rx5ysMtABgMNxmbCdaW3jg9zAnhEkpwtxReeFvMGJA/formResponse",
            entryId: localStorage.getItem('chat_entry_id') || "entry.732896261",
            csvUrl: localStorage.getItem('chat_csv_url') || "https://docs.google.com/spreadsheets/d/1f5z-VcfuPnZYKuZTH1qFerR_ZkNfxjRNrD0Izt8jUQ4/export?format=csv",
            cooldown: 5000,
            refreshRate: 8000
        };

        const cursor = document.getElementById('custom-cursor');
        const dot = document.getElementById('cursor-dot');

        document.addEventListener('mousemove', (e) => {
            dot.style.left = e.clientX + 'px';
            dot.style.top = e.clientY + 'px';
            cursor.style.left = e.clientX + 'px';
            cursor.style.top = e.clientY + 'px';
            const isClickable = e.target.closest('button, a, input, textarea, [role="button"], .cursor-help');
            document.body.classList.toggle('cursor-hover', !!isClickable);
        });

        document.addEventListener('mousedown', (e) => {
            const ripple = document.createElement('div');
            ripple.className = 'click-ripple';
            ripple.style.left = e.clientX + 'px'; ripple.style.top = e.clientY + 'px';
            document.body.appendChild(ripple);
            setTimeout(() => ripple.remove(), 400);
        });

        const _v = (s) => atob(s);
        const BANNED = [[_v('ZnVjaw=='), false], [_v('c2hpdA=='), false], [_v('YXNz'), true]];
        const sanitize = (text) => {
            const clean = text.toLowerCase();
            return BANNED.some(([p]) => clean.includes(p));
        };

        let lastSentTime = 0;
        let isConnected = true;
        let lastCsvData = ""; 
        
        // --- USER IDENTITY FROM COOKIES ---
        let myBadge = getCookie('chat_user_uid');
        if (!myBadge) {
            myBadge = Math.random().toString(36).substring(2, 8).toUpperCase().substring(0, 2);
            setCookie('chat_user_uid', myBadge);
        }

        let myColor = getCookie('chat_user_color');
        if (!myColor) {
            myColor = `hsl(${Math.random() * 360}, 65%, 65%)`;
            setCookie('chat_user_color', myColor);
        }

        const form = document.getElementById('chat-form');
        const input = document.getElementById('msg-input');
        const messagesContainer = document.getElementById('messages-container');
        const statusBadge = document.getElementById('status-badge');
        const devModal = document.getElementById('dev-modal');

        lucide.createIcons();

        function toggleDevModal() { devModal.classList.toggle('hidden-element'); }
        function saveDevSettings() {
            localStorage.setItem('chat_entry_id', document.getElementById('input-entry-id').value.trim());
            localStorage.setItem('chat_form_url', document.getElementById('input-form-url').value.trim());
            localStorage.setItem('chat_csv_url', document.getElementById('input-csv-url').value.trim());
            window.location.reload();
        }
        statusBadge.addEventListener('dblclick', toggleDevModal);

        async function fetchHistory() {
            try {
                const response = await fetch(CONFIG.csvUrl + `&t=${Date.now()}`, { cache: "no-store" });
                if (!response.ok) throw new Error();
                const currentData = await response.text();
                
                if (currentData !== lastCsvData) {
                    const rows = currentData.split('\n').filter(r => r.trim());
                    const loader = document.getElementById('loading-state');
                    if (loader) loader.remove();

                    messagesContainer.innerHTML = '';
                    rows.forEach((row, index) => {
                        if (index === 0) return; 
                        const cols = parseCSVLine(row);
                        
                        // Row validation: Skip if empty or malformed
                        if (cols.length > 1 && cols[1].trim() !== "") {
                            const timestamp = cols[0];
                            const message = cols[1];
                            
                            // Check if this message was sent by us using the persistent cookie fingerprint
                            const fingerprint = `${message}|${timestamp.substring(0, timestamp.lastIndexOf(':'))}`;
                            const isMe = myFingerprints.has(fingerprint);
                            
                            appendMessageUI(message, isMe, index + 1);
                        }
                    });
                    lastCsvData = currentData;
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                    statusBadge.classList.remove('animate-sync');
                    void statusBadge.offsetWidth;
                    statusBadge.classList.add('animate-sync');
                    setTimeout(() => statusBadge.classList.remove('animate-sync'), 1000);
                }
                updateConnection(true);
            } catch (err) { updateConnection(false); }
        }

        function parseCSVLine(line) {
            const result = []; let current = ''; let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                if (line[i] === '"') inQuotes = !inQuotes;
                else if (line[i] === ',' && !inQuotes) { result.push(current); current = ''; }
                else current += line[i];
            }
            result.push(current);
            return result.map(s => s.replace(/^"|"$/g, '').trim());
        }

        function appendMessageUI(text, isMe, rowNum) {
            const wrapper = document.createElement('div');
            wrapper.className = `flex ${isMe ? 'justify-end' : 'justify-start'} message-entry`;
            const bgColor = isMe ? 'bg-indigo-600 shadow-indigo-500/10' : 'bg-slate-800 shadow-black/10';
            
            wrapper.innerHTML = `
                <div class="flex max-w-[85%] md:max-w-[70%] ${isMe ? 'flex-row-reverse' : 'flex-row'} gap-3">
                    <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center text-[10px] font-bold shadow-md transition-transform hover:scale-110 ${isMe ? '' : 'bg-slate-700 text-slate-400'}" 
                         style="${isMe ? `background-color: ${myColor}` : ''}">
                        ${isMe ? myBadge : '??'}
                    </div>
                    <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                        <div class="px-4 py-2.5 rounded-2xl text-sm border border-slate-700/30 glass-bubble transition-all ${bgColor} ${isMe ? 'text-white rounded-tr-none' : 'text-slate-200 rounded-tl-none'}">
                            ${text}
                        </div>
                        <span class="text-[8px] text-slate-600 mt-1 uppercase tracking-tighter">
                            ${rowNum ? `Row ${rowNum}` : 'Syncing...'}
                        </span>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(wrapper);
        }

        function updateConnection(status) {
            isConnected = status;
            statusBadge.className = `cursor-help select-none flex items-center gap-1.5 px-3 py-1 rounded-full border transition-transform active:scale-95 ${status ? 'bg-emerald-500/10 border-emerald-500/20 text-emerald-500' : 'bg-rose-500/10 border-rose-500/20 text-rose-500'}`;
            document.getElementById('status-text').innerText = status ? "Online" : "Offline";
        }

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const now = Date.now();
            const text = input.value.trim();
            if (!text || !isConnected || now - lastSentTime < CONFIG.cooldown) return;
            if (sanitize(text)) { input.value = ""; return; }
            
            lastSentTime = now;
            
            const d = new Date();
            const timeKey = `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()} ${d.getHours()}:${d.getMinutes().toString().padStart(2, '0')}`;
            const fingerprint = `${text}|${timeKey}`;
            
            myFingerprints.add(fingerprint);
            saveFingerprints(); // Persistent cookie save
            
            input.value = '';
            appendMessageUI(text, true);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            const formData = new URLSearchParams();
            formData.append(CONFIG.entryId, text);
            fetch(CONFIG.formUrl, { 
                method: 'POST', mode: 'no-cors', 
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData.toString() 
            }).then(() => setTimeout(fetchHistory, 2000));
        });

        window.onload = () => { fetchHistory(); setInterval(fetchHistory, CONFIG.refreshRate); };
        input.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); form.dispatchEvent(new Event('submit')); } });
    </script>
</body>
</html>
